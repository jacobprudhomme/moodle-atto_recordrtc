YUI.add("moodle-atto_recordrtc-premiumrecording",function(e,t){M.atto_recordrtc=M.atto_recordrtc||{};var n=M.atto_recordrtc.premiumcommonmodule;M.atto_recordrtc.premiumcommonmodule={editorScope:null,alertWarning:null,alertDanger:null,player:null,playerDOM:null,startStopBtn:null,uploadBtn:null,recType:null,stream:null,mediaRecorder:null,olderMoodle:null,socket:null,check_secure:function(){var e=window.location.protocol==="https:"||window.location.host.indexOf("localhost")!==-1;e||n.alertDanger.ancestor().ancestor().removeClass("hide")},check_browser:function(){window.bowser.firefox&&window.bowser.version>=29||window.bowser.chrome&&window.bowser.version>=49||window.bowser.opera&&window.bowser.version>=36||n.alertWarning.ancestor().ancestor().removeClass("hide")},init_connection:function(){n.socket.connect(),n.socket.on("connect",function(){n.socket.emit("authentication",{key:n.editorScope.get("apikey"),secret:n.editorScope.get("apisecret")}),n.socket.on("authenticated",function(){}),n.socket.on("unauthorized",function(t){n.editorScope.closeDialogue(n.editorScope),e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("notpremium_title","atto_recordrtc"),message:M.util.get_string("notpremium","atto_recordrtc")})})})}),n.socket.on("connect_error",function(){n.editorScope.closeDialogue(n.editorScope),e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("servernotfound_title","atto_recordrtc"),message:M.util.get_string("servernotfound","atto_recordrtc")})})})},capture_user_media:function(e,t,n){window.navigator.mediaDevices.getUserMedia(e).then(t).catch(n)},handle_data_available:function(e){n.socket.emit("data available",e.data)},handle_stop:function(e){n.startStopBtn.set("textContent","Start Recording"),n.socket.emit("recording stopped"),n.socket.on("save finished",function(e){n.player.set("src",e),n.player.set("controls",!0),n.player.set("muted",!1),n.player.ancestor().ancestor().removeClass("hide")})},start_recording:function(e,t){var r=(Math.random()*1e3).toString().replace(".","");e==="audio"?r+="-audio.ogg":r+="-video.webm";var i={contextid:n.editorScope.get("contextid"),type:n.recType,itemid:n.editorScope.get("sesskey"),filename:r};n.socket.emit("recording started",i);var s=null;e==="audio"?window.MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?s={audioBitsPerSecond:n.editorScope.get("audiobitrate"),mimeType:"audio/webm;codecs=opus"}:window.MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")&&(s={audioBitsPerSecond:n.editorScope.get("audiobitrate"),mimeType:"audio/ogg;codecs=opus"}):window.MediaRecorder.isTypeSupported("video/webm;codecs=vp9,opus")?s={audioBitsPerSecond:n.editorScope.get("audiobitrate"),videoBitsPerSecond:n.editorScope.get("videobitrate"),mimeType:"video/webm;codecs=vp9,opus"}:window.MediaRecorder.isTypeSupported("video/webm;codecs=h264,opus")?s={audioBitsPerSecond:n.editorScope.get("audiobitrate"),videoBitsPerSecond:n.editorScope.get("videobitrate"),mimeType:"video/webm;codecs=h264,opus"}:window.MediaRecorder.isTypeSupported("video/webm;codecs=vp8,opus")&&(s={audioBitsPerSecond:n.editorScope.get("audiobitrate"),videoBitsPerSecond:n.editorScope.get("videobitrate"),mimeType:"video/webm;codecs=vp8,opus"}),n.mediaRecorder=s?new window.MediaRecorder(t,s):new window.MediaRecorder(t),n.socket.on("recording started",function(){n.startStopBtn.set("textContent",M.util.get_string("stoprecording","atto_recordrtc")),n.startStopBtn.set("disabled",!1),n.player.set("muted",!0),n.mediaRecorder.ondataavailable=n.handle_data_available,n.mediaRecorder.onstop=n.handle_stop,n.mediaRecorder.start(1500)})},create_annotation:function(e,t){var n=window.prompt(M.util.get_string("annotationprompt","atto_recordrtc"),M.util.get_string("annotation:"+e,"atto_recordrtc"));if(!n)return undefined;var r='<a target="_blank" href="'+t+'">'+n+"</a>";return r},insert_annotation:function(e,t){var r=n.create_annotation(e,t);r?n.editorScope.setLink(n.editorScope,r):n.uploadBtn.set("textContent",M.util.get_string("attachrecording","atto_recordrtc"))}},M.atto_recordrtc=M.atto_recordrtc||{};var n=M.atto_recordrtc.premiumcommonmodule;M.atto_recordrtc.premiumaudiomodule={init:function(t){n.editorScope=t,n.alertWarning=e.one("div#alert-warning"),n.alertDanger=e.one("div#alert-danger"),n.player=e.one("audio#player"),n.playerDOM=document.querySelector("audio#player"),n.startStopBtn=e.one("button#start-stop"),n.uploadBtn=e.one("button#upload"),n.recType="audio",n.olderMoodle=t.get("oldermoodle"),n.socket=window.io(n.editorScope.get("serverurl")),n.check_secure(),n.check_browser(),n.init_connection(),n.startStopBtn.on("click",function(){n.startStopBtn.set("disabled",!0);if(n.startStopBtn.get("textContent")===M.util.get_string("startrecording","atto_recordrtc")||n.startStopBtn.get("textContent")===M.util.get_string("recordagain","atto_recordrtc")||n.startStopBtn.get("textContent")===M.util.get_string("recordingfailed","atto_recordrtc")){n.player.ancestor().ancestor().addClass("hide"),n.uploadBtn.ancestor().ancestor().addClass("hide"),n.olderMoodle||n.startStopBtn.replaceClass("btn-outline-danger","btn-danger");var t={onMediaCaptured:function(e){n.stream=e,n.start_recording(n.recType,n.stream)},onMediaStopped:function(e){n.startStopBtn.set("textContent",e),n.startStopBtn.set("disabled",!1),n.olderMoodle||n.startStopBtn.replaceClass("btn-danger","btn-outline-danger")},onMediaCapturingFailed:function(r){var i=M.util.get_string("recordingfailed","atto_recordrtc");switch(r.name){case"AbortError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumabort_title","atto_recordrtc"),message:M.util.get_string("gumabort","atto_recordrtc")})}),t.onMediaStopped(i);break;case"NotAllowedError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumnotallowed_title","atto_recordrtc"),message:M.util.get_string("gumnotallowed","atto_recordrtc")})}),t.onMediaStopped(i);break;
case"NotFoundError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumnotfound_title","atto_recordrtc"),message:M.util.get_string("gumnotfound","atto_recordrtc")})}),t.onMediaStopped(i);break;case"NotReadableError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumnotreadable_title","atto_recordrtc"),message:M.util.get_string("gumnotreadable","atto_recordrtc")})}),t.onMediaStopped(i);break;case"OverConstrainedError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumoverconstrained_title","atto_recordrtc"),message:M.util.get_string("gumoverconstrained","atto_recordrtc")})}),t.onMediaStopped(i);break;case"SecurityError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumsecurity_title","atto_recordrtc"),message:M.util.get_string("gumsecurity","atto_recordrtc")})}),n.editorScope.closeDialogue(n.editorScope);break;case"TypeError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumtype_title","atto_recordrtc"),message:M.util.get_string("gumtype","atto_recordrtc")})}),t.onMediaStopped(i);break;default:}}};M.atto_recordrtc.premiumaudiomodule.capture_audio(t)}else window.setTimeout(function(){n.startStopBtn.set("disabled",!1)},1e3),M.atto_recordrtc.premiumaudiomodule.stop_recording(n.stream),n.startStopBtn.set("textContent",M.util.get_string("recordagain","atto_recordrtc")),n.olderMoodle||n.startStopBtn.replaceClass("btn-danger","btn-outline-danger")})},capture_audio:function(e){n.capture_user_media({audio:!0},function(t){n.playerDOM.srcObject=t,e.onMediaCaptured(t)},function(t){e.onMediaCapturingFailed(t)})},stop_recording:function(t){n.mediaRecorder.stop(),t.getTracks().forEach(function(e){e.stop()}),n.uploadBtn.ancestor().ancestor().removeClass("hide"),n.uploadBtn.set("textContent",M.util.get_string("attachrecording","atto_recordrtc")),n.uploadBtn.set("disabled",!1),n.uploadBtn.on("click",function(){n.player.get("src")?(n.uploadBtn.set("disabled",!0),n.insert_annotation(n.recType,n.player.get("src"))):e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("norecordingfound_title","atto_recordrtc"),message:M.util.get_string("norecordingfound","atto_recordrtc")})})})}},M.atto_recordrtc=M.atto_recordrtc||{};var n=M.atto_recordrtc.premiumcommonmodule;M.atto_recordrtc.premiumvideomodule={init:function(t){n.editorScope=t,n.alertWarning=e.one("div#alert-warning"),n.alertDanger=e.one("div#alert-danger"),n.player=e.one("video#player"),n.playerDOM=document.querySelector("video#player"),n.startStopBtn=e.one("button#start-stop"),n.uploadBtn=e.one("button#upload"),n.recType="video",n.olderMoodle=t.get("oldermoodle"),n.socket=window.io(n.editorScope.get("serverurl")),n.check_secure(),n.check_browser(),n.init_connection(),n.startStopBtn.on("click",function(){n.startStopBtn.set("disabled",!0);if(n.startStopBtn.get("textContent")===M.util.get_string("startrecording","atto_recordrtc")||n.startStopBtn.get("textContent")===M.util.get_string("recordagain","atto_recordrtc")||n.startStopBtn.get("textContent")===M.util.get_string("recordingfailed","atto_recordrtc")){n.uploadBtn.ancestor().ancestor().addClass("hide"),n.olderMoodle||n.startStopBtn.replaceClass("btn-outline-danger","btn-danger");var t={onMediaCaptured:function(e){n.stream=e,n.start_recording(n.recType,n.stream)},onMediaStopped:function(e){n.startStopBtn.set("textContent",e),n.startStopBtn.set("disabled",!1),n.olderMoodle||n.startStopBtn.replaceClass("btn-danger","btn-outline-danger")},onMediaCapturingFailed:function(r){var i=M.util.get_string("recordingfailed","atto_recordrtc");switch(r.name){case"AbortError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumabort_title","atto_recordrtc"),message:M.util.get_string("gumabort","atto_recordrtc")})}),t.onMediaStopped(i);break;case"NotAllowedError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumnotallowed_title","atto_recordrtc"),message:M.util.get_string("gumnotallowed","atto_recordrtc")})}),t.onMediaStopped(i);break;case"NotFoundError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumnotfound_title","atto_recordrtc"),message:M.util.get_string("gumnotfound","atto_recordrtc")})}),t.onMediaStopped(i);break;case"NotReadableError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumnotreadable_title","atto_recordrtc"),message:M.util.get_string("gumnotreadable","atto_recordrtc")})}),t.onMediaStopped(i);break;case"OverConstrainedError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumoverconstrained_title","atto_recordrtc"),message:M.util.get_string("gumoverconstrained","atto_recordrtc")})}),t.onMediaStopped(i);break;case"SecurityError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumsecurity_title","atto_recordrtc"),message:M.util.get_string("gumsecurity","atto_recordrtc")})}),n.editorScope.closeDialogue(n.editorScope);break;case"TypeError":e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("gumtype_title","atto_recordrtc"),message:M.util.get_string("gumtype","atto_recordrtc")})}),t.onMediaStopped(i);break;default:}}};n.player.ancestor().ancestor().removeClass("hide"),n.player.set("controls",!1),M.atto_recordrtc.premiumvideomodule.capture_audio_video(t)}else window.setTimeout(function(){n.startStopBtn.set("disabled",!1)},1e3),M.atto_recordrtc.premiumvideomodule.stop_recording(n.stream),n.startStopBtn.set("textContent",M.util.get_string("recordagain","atto_recordrtc")),n.olderMoodle||n.startStopBtn.replaceClass("btn-danger","btn-outline-danger")})},capture_audio_video:function(e){n.capture_user_media({audio:!0,video:{width:{ideal:640},height
:{ideal:480}}},function(t){n.playerDOM.srcObject=t,n.playerDOM.play(),e.onMediaCaptured(t)},function(t){e.onMediaCapturingFailed(t)})},stop_recording:function(t){n.mediaRecorder.stop(),t.getTracks().forEach(function(e){e.stop()}),n.uploadBtn.ancestor().ancestor().removeClass("hide"),n.uploadBtn.set("textContent",M.util.get_string("attachrecording","atto_recordrtc")),n.uploadBtn.set("disabled",!1),n.uploadBtn.on("click",function(){n.player.get("src")?(n.uploadBtn.set("disabled",!0),n.insert_annotation(n.recType,n.player.get("src"))):e.use("moodle-core-notification-alert",function(){new M.core.alert({title:M.util.get_string("norecordingfound_title","atto_recordrtc"),message:M.util.get_string("norecordingfound","atto_recordrtc")})})})}}},"@VERSION@",{requires:["moodle-atto_recordrtc-button"]});
